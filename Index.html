<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Station Data Report</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    #file-upload {
      margin-bottom: 20px;
      text-align: center;
    }
    #results {
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #download-pdf-btn {
      margin-top: 20px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>Station Data Report Generator</h1>
  <div id="file-upload">
    <input type="file" id="csv-file" accept=".csv">
    <button id="upload-btn">Upload CSV</button>
  </div>
  <div id="results"></div>
  <button id="download-pdf-btn" disabled>Download PDF Report</button>

  <script>
    const csvFile = document.getElementById('csv-file');
    const uploadBtn = document.getElementById('upload-btn');
    const resultsDiv = document.getElementById('results');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');

    let reportData = '';  // Stores the report content for the PDF

    uploadBtn.addEventListener('click', () => {
      if (!csvFile.files.length) {
        alert('Please upload a CSV file.');
        return;
      }

      const reader = new FileReader();
      reader.onload = (event) => {
        const csvData = event.target.result;
        const lines = csvData.split('\n').map(line => line.trim());

        // Extract metadata from the CSV file
        const stationId = lines[0].split(',')[0];
        const elementIds = lines[1].split(','); // There might be more than one element
        const year = lines[2].split(',')[0];
        const month = lines[3].split(',')[0];

        // Initialize variables to store element data
        let temperatureData = [];
        let humidityData = [];
        let rainfallData = [];

        // Process the remaining lines (starting from row 6 onwards)
        for (let i = 5; i < lines.length; i++) {
          const row = lines[i].split(',');
          for (let j = 0; j < elementIds.length; j++) {
            const value = parseFloat(row[j]);

            if (!isNaN(value)) {
              const elementId = parseInt(elementIds[j]);
              if (elementId === 2) {
                temperatureData.push(value);
              } else if (elementId === 3) {
                humidityData.push(value);
              } else if (elementId === 4) {
                rainfallData.push(value);
              }
            }
          }
        }

        // Calculate averages and sums
        const calculateAverage = (data) => data.reduce((sum, val) => sum + val, 0) / data.length || 0;
        const calculateSum = (data) => data.reduce((sum, val) => sum + val, 0) || 0;

        const avgTemp = calculateAverage(temperatureData);
        const avgHumidity = calculateAverage(humidityData);
        const totalRainfall = calculateSum(rainfallData);

        // Display results in HTML
        let reportText = `<h2>Station Data Report</h2>`;
        reportText += `<p><strong>Station ID:</strong> ${stationId}</p>`;
        reportText += `<p><strong>Year:</strong> ${year}</p>`;
        reportText += `<p><strong>Month:</strong> ${month}</p>`;
        
        let summary = '';
        if (temperatureData.length > 0) {
          summary += `<p><strong>Average Temperature:</strong> ${avgTemp.toFixed(2)}°C</p>`;
        }
        if (humidityData.length > 0) {
          summary += `<p><strong>Average Humidity:</strong> ${avgHumidity.toFixed(2)}%</p>`;
        }
        if (rainfallData.length > 0) {
          summary += `<p><strong>Total Rainfall:</strong> ${totalRainfall.toFixed(2)} mm</p>`;
        }

        reportText += summary;
        resultsDiv.innerHTML = reportText;

        // Prepare data for PDF
        reportData = {
          stationId,
          year,
          month,
          avgTemp: temperatureData.length > 0 ? avgTemp.toFixed(2) : null,
          avgHumidity: humidityData.length > 0 ? avgHumidity.toFixed(2) : null,
          totalRainfall: rainfallData.length > 0 ? totalRainfall.toFixed(2) : null,
        };

        downloadPdfBtn.disabled = false;  // Enable download button
      };

      reader.readAsText(csvFile.files[0]);
    });

    downloadPdfBtn.addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      pdf.setFontSize(16);
      pdf.text('Station Data Report', 10, 10);
      pdf.setFontSize(12);
      pdf.text(`Station ID: ${reportData.stationId}`, 10, 20);
      pdf.text(`Year: ${reportData.year}`, 10, 30);
      pdf.text(`Month: ${reportData.month}`, 10, 40);
      if (reportData.avgTemp) {
        pdf.text(`Average Temperature: ${reportData.avgTemp}°C`, 10, 50);
      }
      if (reportData.avgHumidity) {
        pdf.text(`Average Humidity: ${reportData.avgHumidity}%`, 10, 60);
      }
      if (reportData.totalRainfall) {
        pdf.text(`Total Rainfall: ${reportData.totalRainfall} mm`, 10, 70);
      }

      // Save the PDF
      pdf.save('station_data_report.pdf');
    });
  </script>
</body>
</html>
